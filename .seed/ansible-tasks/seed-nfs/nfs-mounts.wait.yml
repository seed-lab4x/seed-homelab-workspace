# code: language=ansible
---

- name: nfs-mounts.wait|debug share
  ansible.builtin.debug:
    verbosity: 3
    var: mounts_share

- name: nfs-mounts.wait|assert param
  ansible.builtin.assert:
    that:
      - mounts is defined
      - mounts | type_debug == 'list'
    msg: "var eval fail {{ mounts }}"
    quiet: true

- name: nfs-mounts.wait|fact param
  ansible.builtin.set_fact:
    _mounts: "{{ mounts | flatten }}"

- vars:
    share_mode: "{{ mounts_share.mode | default('index') }}"
    share_group: "{{ mounts_share.group | default('nfs-client',true) }}"
  block:
  - name: nfs-mounts.wait|index|loop
    loop: "{{ range(0, _mounts | length, 1) | list }}"
    loop_control:
      loop_var: mount_index
    when:
      - share_mode == 'index'
      - inventory_hostname in groups[mount_share.group] | default([],true)
    include_tasks: nfs-mount.wait.yml
    vars:
      mount: "{{ _mounts[mount_index] }}"
      mount_share:
        any: false
        group: "{{ mount.group | default(share_group,true) }}"

  - name: nfs-mounts.wait|value|loop
    loop: "{{ _mounts }}"
    loop_control:
      loop_var: mount
    when:
      - share_mode == 'value'
      - inventory_hostname in groups[mount_share.group] | default([],true)
    include_tasks: ../seed-task.once.yml
    vars:
      task_share:
        run_once: "{{ mount.once | default(false) }}"
        task: seed-nfs/nfs-mount.wait.yml
      mount_share:
        any: "{{ mount.any | default(false) }}"
        group: "{{ mount.group | default(share_group,true) }}"

- name: nfs-mounts.wait|unfact param
  run_once: true
  ansible.builtin.set_fact:
    _mounts: !!null
